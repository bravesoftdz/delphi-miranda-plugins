#summary Сервисный плагин для создания и обработки макрокоманд
<wiki:toc/>
== Назначение ==
Данный сервисный плагин может быть использован для определения, изменения и выполнения
различных действий, список которых будет представлен в более подробном описании ниже.

== Основные возможности ==
 * [[#Открытие окна беседы для контакта|Открытие окна беседы для контакта]]
 * [[#Запуск программы|Выполнение программы]]
 * [[#Выполнение сервиса|Вызов сервисов]]
 * [[#Дополнительные действия|Выполнение дополнительных действий по условию]]
 * [[#Вставка текста|Вставка текста в текстовые поля (не только миранды)]]
 * Объединение отдельных действий в группы
 * [[#Чтение-запись данных профиля|Осуществлять чтение-запись данных профиля]]

== Описание диалога настроек ==
Основное окно настроек состоит из двух списков: списка групп действий (сверху) и списка отдельных действий.
Кнопки управления позволяют добавлять новые пункты в список, удалять их или перемещать.
Рядом со списком групп действий находятся так же кнопки для проверки введенных действий и отмены изменений, импорта и экспорта.
Переименование групп действий либо самих действий происходит по двойному клику на названии либо при нажатии кнопки F2.

=== Открытие окна беседы для контакта ===
Необходимо выбрать нужный контакт из списка. Именно для него и будет высвечено окно сообщений.

=== Выполнение сервиса ===
Несколько сложные на вид, но универсальные настройки для вызова сервиса миранды.
wParam и lParam комбобоксы в верхней части позволяют выбрать тип параметра
 * _number_          - целое число
 * _ANSI string_     - строка ANSI
 * _Unicode string_  - строка Unicode
 * _Current contact_ - параметр - хандл текущего контакта. Это контакт, которому принадлежит активное окно беседы.
 * _Last result_     - результат предыдущего действия
 * _Parameter_       - параметр, заданный при запуске группы действий на выполнение
 * _Structure_       - параметр - структура, которая может быть отредактирована в окне настроек.

поля wParam и lParam в нижней части для значений, передаваемых в сервис.
Если в папке плагинов присутствует файл _service.ini_, то, находясь в диалоге настроек, можно нажать F1 для того, чтоб увидеть короткую справку для выбранного в комбобоксе имени сервиса.
Большая часть сверху занята тем, что нужно сделать с результатом выполнения сервиса:
показать во всплывающем окне или окне сообщений или вставить в текст.
Результат может быть представлен как целое число, шестнадцатеричное число, строка (ANSI или Unicode) либо элемент структуры.
Строка `'<proto>'` в имени сервиса перед выполнением заменяется на название протокола для контакта, хандл которого хранится как параметр при вызове последовательности действий.

==== Редактор структур ====
Окно (список) слева будет содержать элементы структуры. Первый столбец - тип, второй - размер элемента (фактически, только для массивов), третий - значение элемента. Чекбокс в первом столбце служит для пометки, какой элемент структуры будет использован для возврата значения после выполнения сервиса.
Кнопки справа от списка служат для добавления элемента, удаления его и перемещения к началу/концу структуры.
Выпадающий список справа вверху служит для выбора типа элемента структуры.
Поле размера данных (поле под выпадающим списком) предназначено для указания размера блока памяти в байтах в случае массивов и указателей на буфер.
Длинное поле ниже поля размера данных служит для ввода непосредственно самого значения. При этом часть текста типа $#### (для массивов или указателей на слова) или $##, где ## - шестнадцатеричные цифры, будут представлены как слова или байты соответственно.
Знак "|" используется как разделитель полей в итоговом описании структуры, поэтому нежелательно его использование в текстах, вместо этого можно написать $7C или $007C (в случае юникодного текста)
Это описание можно получить и нажав F1 или кнопку "Помощь" в окне диалога.

=== Запуск программы ===
Настройки процесса: параллельное выполнение (программа запускается, а действия продолжают выполняться) и последовательное (следующее действие будет выполнено лишь после завершения работы программы).
Время ожидания завершения программы задается в текстовом поле.
В имени программы могут быть использованы макросы:
 * `<param>` - параметр
 * `<last>`  - результат последнего действия

=== Вставка текста ===
Данное действие делится на три варианта: работа с буфером обмена, файлом либо окном.
При выборе работы с буфером обмена становятся доступны опции, устанавливающие тип текста (Ansi/Unicode) и направление (в буфер/из буфера).
Работа с файлами заключается в чтении, дополнении либо записи *юникодного* текста из файла / в файл.
Если имя файла не указано, результат будет сохранен для следующего действия без записи в файл.
Поле ввода предназначено для текста, который будет вставлен в активное окно (не только миранды). Если установлен флаг  для использования плагина _Variables_, текст предварительно будет обработан этим плагином.
В самом тексте можно указывать некоторые специальные _макросы_, список которыхможно посмотреть, нажав F1.

=== Дополнительные действия ===
Настройки состоят из трех частей: предусловие, действие, постдействие.
{{{
'Значение' это число, с которым будет идти сравнение на этапе предусловия.
}}}
Если условие выполняется, то далее могут быть выполнены следующие действия:
{{{
'Math'  - метематические действия с результатом выполнения предыдущего действия и числом в поле 'Значение'.
}}}

Как вариант, может быть выполнен скрипт для модуля _Variables_. Макросы %subject% и %extratext% при этом так же могут быть использованы. Если указана опция "Результат как число", результирующий текст после обработки плагином _Variables_ будет преобразован в число.

Постдействие может быть одним из следующих:
{{{
'BREAK' - прервать выполнение группы действий (и вернуться к 'родительской' груцппе, если таковая существует)
'JUMP'  - переход на действие внутри группы с именем 'значение' - выбирается из списка
'NOP'   - без операции
}}}

=== Выполнение другой цепочки ===
Необходимо просто выбрать имя группы действий из списка. После прекращения выполнения ее, управление передастся обратно вызывающей цепочке.

=== Чтение-запись данных профиля ===
Действие предназначено для чтения или записи данных профиля пользователя.
Ниже выбора операции (чтение или запись) можно выбрать тип данных, которые мы хотим прочитать или записать.
{{{
'Последний результат' - это результат выполнения предыдущего действия.
}}}
Группа радиокнопок задает тип контакта, для которого осуществляется операция чтения-записи.
{{{
'Настройки пользователя' - все операции осуществляются с настройками пользователя
'Параметр'               - используются настройки контакта с хандлом, переданным в параметре при вызове группы действий
'Последний результат'    - Хандл контакта берется из результата выполнения предыдущего действия
'Ручной'                 - контакт выбирается из списка
}}}
Строка `'<proto>'` в имени модуля заменяется на название протокола для выбранного контакта.

=== Message Box ===
Реализация вывода стандартного MessageBox. Можно ввести заголовок и текст для окна сообщения, а также указать, какие кнопки и (если надо) иконка будут показаны в сообщении. В следующем действии можно будет проверить результат (код нажатой кнопки).
Текст `<last>` в заголовке либо тексте будет заменен на значение последнего результата.

== Импорт/экспорт ==
При наличии "движка" XML становятся доступными кнопки Импорта/экспорта настроек.

=== Экспорт ===
В списке групп действий можно выбрать одну или несколько групп для импорта. При нажатии на кнопку "Экспорт" вызывается диалоговое окно для выбора имени файла, куда будут записанные данные. Если файл существует, сперва возникнет запрос, переписать ли его, а в случае положительного ответа пользователь получить возможность выбрать, дополнить файл или переписать его целиком.

=== Импорт ===
Импорт возможен как для одной группы действий, так и для нескольких, в зависимости от содержимого файла, откуда будет вестись импорт. Нажатие на кнопку "Импорт" откроет диалоговое окно, где можно выбрать необходимое имя файла.

=== Формат файла экспорта ===
В силу действующих на данный момент ограничений, файл должен быть в кодировке Unicode, код символов в младшем байте. Префикс, задающий порядок байт и прочие кодировки - недопустимы.
По мере развития плагина, структура файла может меняться.


 <*ActMan_Export*>
   <*Action* name="" disabled="_0/1_">
     <*Subaction* name="" disabled="_0/1_">

       <*Contact* number=""/>

       <*RunProgram* args="" current="_0/1_" wait="" parallel="_0/1_" window="_hidden/maximized/minimized/normal_ variables="_0/1_">
         path
       </*RunProgram*>

       <*CallService* service="">
 *       <*OUTPUT* message="0/1" dest="popup/msgbox" type="_signed/hex/ansi/unicode/int_">
 *       <*WPARAM* type="_number/ansi/unicode/current/result/param/struct_" value=""/>
 *       <*LPARAM* type="_number/ansi/unicode/current/result/param/struct_" value=""/>
           <*ITEM* type="_byte/word/dword/array/ansi/unicode/wordstruct/bytestruct/param/result_" value="">

       </*CallService*>

       <*LinkAction*>name</*LinkAction*>

       <*Profile* oper="_read/write_" contact="_current/param/result/contact_" last="_0/1_"
                module="" setting="" type="_byte/word/dword/unicode_" value="">
          text value
       </*Profile*>

       <*Advanced*>
         <*IF* not="_0/1_" cond="_gt/lt/eq_" value=""/>
         <*ACT* type="_value/script_" oper="_inverse/+-`*\`%&|^=_" value="" asint="">
           script
         </*ACT*>
         <*POST* oper="_nop/break/jump_" value="">
       </*Advanced*>


       <*MessageBox* title="" type="">
         text
       </*MessageBox*>

     </*Subaction*>
   </*Action*>
 </*ActMan_Export*>


== Способ использования ==


== Ссылки ==
 * [http://awkward.miranda.im/ страница плагинов]
 * [http://awkward.miranda.im/actman.zip прямая ссылка]
 * [MirandaRuThread|2041}}